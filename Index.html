<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>モバイル対応：顔トラッキング＋サングラス＋カメラ選択</title>
  <style>
    /* ベーススタイル */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%; height: 100%;
      overflow: hidden;
      background: #000;
      font-family: sans-serif;
    }
    /* ビデオとキャンバスを重ねる */
    #video, #overlay {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
    }
    #overlay { pointer-events: none; }
    /* カメラ選択ドロップダウン */
    .controls {
      position: fixed; top: env(safe-area-inset-top);
      left: 0; width: 100%;
      padding: 0.5rem;
      background: rgba(0,0,0,0.7);
      display: flex; justify-content: center;
      z-index: 10;
    }
    .controls select {
      width: 90%; max-width: 360px;
      padding: 0.75rem;
      font-size: 1.1rem;
      border-radius: 8px; border: none;
      background: #fff; color: #000;
    }
  </style>
  <!-- FaceMeshのみ読み込み -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.3/face_mesh.js" crossorigin="anonymous"></script>
</head>
<body>

  <!-- カメラ選択UI -->
  <div class="controls">
    <select id="cameraSelect"></select>
  </div>

  <!-- 動画表示＆オーバーレイ -->
  <video id="video" autoplay playsinline muted></video>
  <canvas id="overlay"></canvas>

  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const ctx = overlay.getContext('2d');
    const select = document.getElementById('cameraSelect');

    let videoInputs = [];
    let stream = null;

    // FaceMesh初期化
    const faceMesh = new FaceMesh({ locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.3/${f}` });
    faceMesh.setOptions({ maxNumFaces:1, minDetectionConfidence:0.5, minTrackingConfidence:0.5 });
    faceMesh.onResults(drawGlasses);

    // サングラス画像読み込み
    const glasses = new Image();
    glasses.src = 'glasses.png';

    // 顔検出結果にサングラスを描画
    function drawGlasses(results) {
      overlay.width = video.videoWidth;
      overlay.height = video.videoHeight;
      ctx.clearRect(0, 0, overlay.width, overlay.height);
      if (!results.multiFaceLandmarks) return;
      const lm = results.multiFaceLandmarks[0];
      const L = lm[33], R = lm[263];
      const lx = L.x * overlay.width, ly = L.y * overlay.height;
      const rx = R.x * overlay.width, ry = R.y * overlay.height;
      const dist = Math.hypot(rx - lx, ry - ly);
      const w = dist * 2.5;
      const h = w * (glasses.height / glasses.width);
      const cx = (lx + rx) / 2 - w / 2;
      const cy = (ly + ry) / 2 - h / 2 - 0.1 * h;
      if (glasses.complete) ctx.drawImage(glasses, cx, cy, w, h);
    }

    // フレーム処理
    async function processFrame() {
      await faceMesh.send({ image: video });
      requestAnimationFrame(processFrame);
    }

    // カメラ起動
    async function startCamera(deviceId) {
      if (stream) stream.getTracks().forEach(t => t.stop());
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId } } });
        video.srcObject = stream;
        await new Promise(r => video.onloadedmetadata = r);
        processFrame();
      } catch (e) {
        console.error('カメラ起動失敗:', e);
      }
    }

    // カメラ一覧取得＆ラベル付きプルダウン
    async function enumerateCameras() {
      try { const temp = await navigator.mediaDevices.getUserMedia({ video:true }); temp.getTracks().forEach(t=>t.stop()); } catch {}
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d=>d.kind==='videoinput');
      videoInputs = cams.map(d=>d.deviceId);
      select.innerHTML = '';
      cams.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.deviceId;
        opt.text = d.label || 'Camera';
        select.appendChild(opt);
      });
    }

    // ドロップダウン変更で切替
    select.addEventListener('change', () => startCamera(select.value));

    // 初期化
    window.addEventListener('load', async () => {
      await enumerateCameras();
      if (videoInputs.length > 0) {
        select.value = videoInputs[0];
        startCamera(videoInputs[0]);
      } else alert('カメラが見つかりません');
    });
  </script>
</body>
</html>
